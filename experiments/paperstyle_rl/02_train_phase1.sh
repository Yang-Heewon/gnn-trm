#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/env.sh"

DATASET="$DATASET" \
MODEL_IMPL="$MODEL_IMPL" \
EMB_MODEL="$EMB_MODEL" \
EMB_TAG="$EMB_TAG" \
EPOCHS="$EPOCHS_PHASE1" \
BATCH_SIZE="$BATCH_SIZE_PHASE1" \
LR="$LR" \
MAX_STEPS="$MAX_STEPS" \
CKPT_DIR="$CKPT_DIR_PHASE1" \
TORCHRUN="$TORCHRUN" \
NPROC_PER_NODE="$NPROC_PER_NODE" \
MASTER_PORT="$MASTER_PORT" \
CUDA_VISIBLE_DEVICES="$CUDA_VISIBLE_DEVICES" \
DDP_FIND_UNUSED="$DDP_FIND_UNUSED" \
DDP_TIMEOUT_MINUTES="$DDP_TIMEOUT_MINUTES" \
TRAIN_STYLE="$TRAIN_STYLE" \
TRAIN_ACC_MODE="$TRAIN_ACC_MODE" \
TRAIN_SANITY_EVAL_EVERY_PCT="$TRAIN_SANITY_EVAL_EVERY_PCT" \
TRAIN_SANITY_EVAL_LIMIT="$TRAIN_SANITY_EVAL_LIMIT" \
TRAIN_SANITY_EVAL_BEAM="$TRAIN_SANITY_EVAL_BEAM" \
TRAIN_SANITY_EVAL_START_TOPK="$TRAIN_SANITY_EVAL_START_TOPK" \
TRAIN_SANITY_EVAL_PRED_TOPK="$TRAIN_SANITY_EVAL_PRED_TOPK" \
TRAIN_SANITY_EVAL_NO_CYCLE="$TRAIN_SANITY_EVAL_NO_CYCLE" \
TRAIN_SANITY_EVAL_USE_HALT="$TRAIN_SANITY_EVAL_USE_HALT" \
WANDB_MODE="$WANDB_MODE" \
WANDB_PROJECT="$WANDB_PROJECT" \
WANDB_ENTITY="$WANDB_ENTITY" \
WANDB_RUN_NAME="$WANDB_RUN_NAME_PHASE1" \
bash trm_rag_style/scripts/run_train_phase1_paperstyle_wandb.sh
